{% extends 'layout.html' %}
{% block content %}
<h2>Consulta de demonstrativos</h2>
{% if current_user %}
  <p class="text-muted">Usuário atual: <strong>{{ current_user['username'] }}</strong> ({{ current_user['role'] }}).</p>
{% endif %}
<form method="get" action="{{ request.url_for('consulta_get') }}" class="form-inline mb-3">
  <label class="mr-2" for="mes_key">Selecione o mês:</label>
  <select class="form-control mr-2" name="mes_key" id="mes_key" required>
    <option value="">-- Selecione --</option>
    {% for key, label in months %}
      <option value="{{ key }}" {% if selected_key == key %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
  </select>
  {% if current_user and current_user['role'] == 'admin' and users %}
    <label class="mr-2 ml-2" for="user_id">Usuário:</label>
    <select class="form-control mr-2" name="user_id" id="user_id">
      <option value="">Todos</option>
      {% for user in users %}
        <option value="{{ user['id'] }}" {% if selected_user_id == user['id'] %}selected{% endif %}>{{ user['username'] }} ({{ user['role'] }})</option>
      {% endfor %}
    </select>
  {% endif %}
  <button type="submit" class="btn btn-primary">Consultar</button>
</form>

{% if items %}
  <h4>Itens do mês</h4>
  <table class="table table-striped table-sm table-custom">
    <thead>
      <tr>
        <th>Descrição</th>
        <th>Quantidade</th>
        <th>Proventos (R$)</th>
        <th>Descontos (R$)</th>
        <th>Arquivo</th>
      </tr>
    </thead>
    <tbody>
      {% for row in items %}
      <tr>
        <td>{{ row['descricao'] }}</td>
        <td>{{ row['quantidade'] or '-' }}</td>
        <td>{{ row['proventos'] | currency_br }}</td>
        <td>{{ row['descontos'] | currency_br }}</td>
        <td>{{ row['file_name'] }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% if totals %}
    <h4>Totais consolidados</h4>
    <ul>
      <li><strong>Total de Proventos:</strong> {{ totals['total_proventos'] | currency_br }}</li>
      <li>
        <strong>Total de Descontos:</strong>
        {{ totals['total_descontos'] | currency_br }}
        <span class="text-muted">
          {% if descontos_pct is not none %}
            ({{ '%.2f' | format(descontos_pct) | replace('.', ',') }}%)
          {% else %}
            (—)
          {% endif %}
        </span>
      </li>
      <li>
        <strong>Valor Líquido:</strong>
        {{ totals['liquido'] | currency_br }}
        <span class="text-muted">
          {% if liquido_pct is not none %}
            ({{ '%.2f' | format(liquido_pct) | replace('.', ',') }}%)
          {% else %}
            (—)
          {% endif %}
        </span>
      </li>
    </ul>
  {% endif %}
{% elif selected_key %}
  <p>Nenhum dado encontrado para o mês selecionado.</p>
{% endif %}
{% endblock %}